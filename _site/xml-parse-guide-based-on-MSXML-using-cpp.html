<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN">

<!-- simple jekyll search -->
<script src="//cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.11/dest/simple-jekyll-search.min.js"></script>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <!-- Favicon Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <meta name="google-site-verification" content="GtBOHqwkUyIwJzqdPZ1VheMXW4edMcCJwjFJx5kGdWo" />
    <meta name="google-site-verification" content="41OWG5Vo9v4bjss_dr9CXfFGqd6FOE6iz-amoUsSC4U" />  <!-- Submit github.io to g. -->
    <meta name="google-site-verification" content="ITq_FdS8-Xx5YYhrXsVuWxj1QSFF0GITF53q1O0cMSQ" /> <!-- Submit github.com to g. -->
    <meta name="baidu-site-verification" content="yML3Kpovuo" />
    <meta name="baidu-site-verification" content="code-ZdUPa21nv6" /> <!-- Submit github.com to bd. -->
    <meta name="360-site-verification" content="49ed3d11f562a12a5ba68d3c6d2115b0" />
    <meta name="sogou_site_verification" content="53WDIeIDAM" /> <!-- Submit github.io to sg. -->
    <meta name="msvalidate.01" content="0FE0D36F099AFBB1CAC652EF20A2437F" />

    <title> 史上最最靠谱，又双叒叒(ruò,zhuó)简单的基于MSXML的XML解析指南-C++_极客玩家大白</title>
    <meta name="keywords" content="Python, 大白, VR, 大奔SEO, 大白SEO, 大白技术控, LeetCode, .NET, WPF, "C#", .NET Core, PHP, geekplayer, geekplayers, 极客玩家, RSS, k8s, 生活故事, 一线, 开发者, 编程, 代码, 开源, IT网站,Developer, Programmer, Coder, Geek, IT技术博客">
    <meta name="description"
          content="大白技术控 - 史上最最靠谱，又双叒叒(ruò,zhuó)简单的基于MSXML的XML解析指南">

    <link rel="canonical" href="http://localhost:4000/xml-parse-guide-based-on-MSXML-using-cpp.html">
    <link rel="alternate" type="application/rss+xml" title="极客玩家大白" href="http://localhost:4000/feed.xml">

    <!-- Third-Party CSS -->
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/yanglr/yanglr.github.io/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="//geekplayers.com/bower_components/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/yanglr/yanglr.github.io/bower_components/hover/css/hover-min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/yanglr/yanglr.github.io/bower_components/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="//geekplayers.com/assets/css/syntax.css">
    <link rel="stylesheet" href="//geekplayers.com/assets/css/sidebar-post-nav.css">

    <!-- My CSS -->
    <link rel="stylesheet" href="//geekplayers.com/assets/css/common.css">

    <!-- CSS set in page -->
    
    <!-- <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/yanglr/yanglr.github.io/assets/css/index.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/yanglr/yanglr.github.io/assets/css/sidebar-popular-repo.css"> -->

    <!-- CSS set in layout -->
    
    <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/yanglr/yanglr.github.io/assets/css/sidebar-post-nav.css">
    

    <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/FortAwesome/Font-Awesome@v4.6.3/css/font-awesome.min.css">

    <script type="text/javascript" src="//cdn.jsdelivr.net/gh/yanglr/yanglr.github.io/bower_components/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/gh/yanglr/yanglr.github.io/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

</head>


    <body>

    <script>
        (function () {
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

    <!-- baidu analyisis -->
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?87596be0014a64eee1571944c5130a8e";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-176595919-1">
    </script>
    
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-176595919-1');
    </script>
    
    <script>
        (function () {
            var src = "https://jspassport.ssl.qhimg.com/11.0.1.js?d182b3f28525f2db83acfaaf6e696dba";
            document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>

    <header class="site-header">
    <div class="site-header-topbar">
        <div class="container">
            <div class="topbar-menu">
                
                <div class="item">
                    <a href="/python.html"
                       target="_self"
                       title="Python">
                        Python
                    </a>
                </div>
                
                <div class="item">
                    <a href="/it.html"
                       target="_self"
                       title="IT">
                        IT
                    </a>
                </div>
                
                <div class="item">
                    <a href="/zsxq.html"
                       target="_self"
                       title="星球">
                        星球
                    </a>
                </div>
                
                <div class="item">
                    <a href="/life.html"
                       target="_self"
                       title="故事">
                        故事
                    </a>
                </div>
                
                <div class="item">
                    <a href="/link.html"
                       target="_self"
                       title="友链">
                        友链
                    </a>
                </div>
                
            </div>
        </div>
    </div>
    <div class="container">
        <a id="site-header-brand" href="/" title="大白技术控">
            <span class="octicon octicon-gist-secret"></span>
            大白技术控
        </a>
        <nav class="site-header-nav" role="navigation">
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/algo.html"
                   target="_self"
                   title="算法">
                    算法
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/dabenSeo.html"
                   target="_blank"
                   title="大奔SEO">
                    大奔SEO
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/dabaiSEO.html" 
                           target="_blank"
                     >大白SEO</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/dotnet.html"
                   target="_blank"
                   title=".NET">
                    .NET
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/csharp.html" 
                           target=""
                     >C#</a></li>
                    
                    <li><a href="/wpf.html" 
                           target=""
                     >WPF</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/k8s.html"
                   target="_self"
                   title="k8s">
                    k8s
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/k8s.html" 
                           target=""
                     >k8s</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/archives.html"
                   target="_self"
                   title="Archives">
                    Archives
                </a>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/tools/"
                   target="_blank"
                   title="Tools">
                    Tools
                </a>
                
                <ul class="submenu">
                    
                    <li><a href="/run-liquild-online.html" 
                           target=""
                     >Run Liquid now</a></li>
                    
                    <li><a href="/run-liquild-online-pro.html" 
                           target=""
                     >Run Liquid now Pro</a></li>
                    
                </ul>
                
            </div>
            
            <div class=" site-header-nav-item hvr-underline-from-center">
                <a href="/about.html"
                   target="_self"
                   title="About">
                    About
                </a>
                
            </div>
            
        </nav>
    </div>
</header>


        <div class="content">
            <section class="jumbotron geopattern" data-pattern-id="史上最最靠谱，又双叒叒(ruò,zhuó)简单的基于MSXML的XML解析指南-C++">
    <div class="container">
        <div id="jumbotron-meta-info">
            <!-- <h1>史上最最靠谱，又双叒叒(ruò,zhuó)简单的基于MSXML的XML解析指南-C++</h1> -->
            <h1 style="font-size: 45px;">
                <a class="hvr-underline-from-center" style="display: initial !important;" href="/xml-parse-guide-based-on-MSXML-using-cpp.html" title="史上最最靠谱，又双叒叒(ruò,zhuó)简单的基于MSXML的XML解析指南-C++_极客玩家大白" target="_self" rel="canonical">史上最最靠谱，又双叒叒(ruò,zhuó)简单的基于MSXML的XML解析指南-C++</a>
            </h1>

            <span class="meta-info">
                

                
                
                    <i class="fa fa-user" aria-hidden="true"></i> <a href='http://localhost:4000'>Bravo Yeung</a>
                

                
                                
                
                <span class="octicon octicon-calendar"></span> <font style="color: #ddd;">2019/01/11 02:05:20</font>
                
            </span>
            
            <p>
                
                
                
                
                    
                    <font style="color: #ddd;"><i class="fa fa-folder-open" aria-hidden="true"></i></font>
                    
                        <a style='background-color: #16a085 !important; padding: 2px 6px; border-radius: 4px !important;font-size: 15px;overflow: scroll;' 
                        href="/categories/#xml">xml</a>
                    
                        <a style='background-color: #16a085 !important; padding: 2px 6px; border-radius: 4px !important;font-size: 15px;overflow: scroll;' 
                        href="/categories/#msxml">msxml</a>
                    
                        <a style='background-color: #16a085 !important; padding: 2px 6px; border-radius: 4px !important;font-size: 15px;overflow: scroll;' 
                        href="/categories/#C++">C++</a>
                    
                                    
                
                <!-- <p>out index:1</p>
                <p>size: 3</p> -->
                
                
                                    
                
                <!-- <p>out index:2</p>
                <p>size: 23</p> -->
                
                
                                    
                
                <!-- <p>out index:3</p>
                <p>size: 3</p> -->
                
                
                                    
                
                <!-- <p>out index:4</p>
                <p>size: 5</p> -->
                
                
                                    
                
                <!-- <p>out index:5</p>
                <p>size: 3</p> -->
                            
            </p>

        </div>
    </div>
</section>
<script>
    $(document).ready(function(){

        $('.geopattern').each(function(){
            $(this).geopattern($(this).data('pattern-id'));
        });

    });
</script>
<article class="post container" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="row">

        
        <div class="col-md-9 markdown-body">

            <p>史上最最靠谱且简单的基于MSXML的XML解析指南 - C++版</p>

<hr />

<p>最近做C++相关的项目，遇到同时使用COM和MSXML来解析XML文件中信息的问题，这类问题如果做MFC开发也会经常用到。
在网上搜了一整圈，确实很难找到可用的code，总算自己研究出高效而简单的方法，借此机会总结一下，并分享给大家。</p>

<p>附 VS Project镜像:</p>

<p>SimpleParser4MSXML-cpp: C++语言写的MSXML的简单使用示例, COM 和 MFC 开发中比较常用:</p>

<p><a rel="nofollow noopener noreferrer" target="_blank" href="https://github.com/yanglr/SimpleParser4MSXML-cpp">https://github.com/yanglr/SimpleParser4MSXML-cpp</a></p>

<p>点击“Raw”可看到源码，欢迎fork或star~</p>

<p><br />
首先简要列举一下MSXML技术的基本特点。</p>

<table>
  <thead>
    <tr>
      <th> </th>
      <th>基于 COM 的技术，用于处理 Windows 操作系统随附的 XML。</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a rel="nofollow noopener noreferrer" target="_blank" href="https://msdn.microsoft.com/library/ms763742.aspx">MSXML</a></td>
      <td>提供 DOM 本机实现，同时支持 XPath 和 XSLT。</td>
    </tr>
    <tr>
      <td> </td>
      <td>包含 SAX2 基于事件的分析器。</td>
    </tr>
  </tbody>
</table>

<h2 id="流程设计">流程设计</h2>
<p>首先简要介绍一下大概流程:</p>

<ul>
  <li>初始化COM</li>
  <li>创建一个IDOMDocument对象xmlDoc，使用xmlDoc -&gt; load() 或 loadXML()方法读入 XML源</li>
  <li>调用selectNodes()或者selectSingleNode()函数，选取指定的节点对象。</li>
  <li>通过IXMLDOMNode对象的属性和方法读取节点对象的内容。</li>
  <li>通过IXMLDOMNode对象的属性和方法设置节点对象的内容。</li>
  <li>通过调用xmlDoc -&gt; save()保存XML文件。</li>
  <li>关闭COM
<br /></li>
</ul>

<p><strong>需要解决的问题:</strong></p>

<ul>
  <li>xml信息有哪几种读取形式(xml文件或wchar)</li>
  <li>如何选取节点，and取节点属性有哪些方法？</li>
  <li>IXMLDOMNode 与 IXMLDOMElement 接口有什么联系和区别?</li>
  <li>节点如果是数组，怎么操作？</li>
  <li>如何为属性插入属性</li>
  <li>字符串的转换
<br /></li>
</ul>

<h1 id="xml信息有哪几种读取形式xml文件或wchar">xml信息有哪几种读取形式(xml文件或wchar)</h1>
<ul>
  <li>xml文件
  从文件中导入xml内容，使用url或filePath
    <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">VARIANT_BOOL</span> <span class="n">bSuccess</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="n">HRESULT</span> <span class="n">hr</span> <span class="o">=</span> <span class="n">iXMLDoc</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">(</span><span class="n">CComVariant</span><span class="p">(</span><span class="s">L"./test.xml"</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bSuccess</span><span class="p">);</span> <span class="c1">// 此处的L可以省略</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p>当已变量方式传人filePath时，需要使用c_str()函数转换一下，代码如下:</p>
    <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">VARIANT_BOOL</span> <span class="n">bSuccess</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="n">filePath</span> <span class="o">=</span> <span class="s">"./test.xml"</span><span class="p">;</span>
<span class="n">HRESULT</span> <span class="n">hr</span> <span class="o">=</span> <span class="n">iXMLDoc</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">(</span><span class="n">CComVariant</span><span class="p">(</span><span class="n">filePath</span><span class="p">.</span><span class="n">c_str</span><span class="p">()),</span> <span class="o">&amp;</span><span class="n">bSuccess</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p><br /></p>
  </li>
  <li>已以字符串格式读入的xml完整代码</li>
</ul>

<p>先定义一个<code class="language-plaintext highlighter-rouge">BSTR</code>常量</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">const</span> <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="s">L""</span>
<span class="s">L"&lt;?xml version=</span><span class="se">\"</span><span class="s">1.0</span><span class="se">\"</span><span class="s"> encoding=</span><span class="se">\"</span><span class="s">utf-16</span><span class="se">\"</span><span class="s">?&gt;</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">L"&lt;root desc=</span><span class="se">\"</span><span class="s">Great</span><span class="se">\"</span><span class="s">&gt;</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">L"  &lt;text&gt;Hey&lt;/text&gt;</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">L"    &lt;layouts&gt;</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">L"    &lt;lay index=</span><span class="se">\"</span><span class="s">15</span><span class="se">\"</span><span class="s"> bold=</span><span class="se">\"</span><span class="s">true</span><span class="se">\"</span><span class="s">/&gt;</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">L"    &lt;layoff index=</span><span class="se">\"</span><span class="s">12</span><span class="se">\"</span><span class="s">/&gt;</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">L"    &lt;layin index=</span><span class="se">\"</span><span class="s">17</span><span class="se">\"</span><span class="s">/&gt;</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">L"  &lt;/layouts&gt;</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">L"&lt;/root&gt;</span><span class="se">\r\n</span><span class="s">"</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>然后从<code class="language-plaintext highlighter-rouge">BSTR</code>导入xml内容:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">VARIANT_BOOL</span> <span class="n">bSuccess</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="n">iXMLDoc</span><span class="o">-&gt;</span><span class="n">loadXML</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bSuccess</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>注: BSTR字符串是用于COM组件对象模型的字符串格式, 字符串以表示字符串长度的4字节整数开始, 然后跟上UTF-16编码的wchar_t字符串（包括\0结束标志）。BSTR类型的变量是一个指针, 指向字符串的第一个字符处。
<br /></p>
<h1 id="如何选取节点and取节点属性有哪些方法">如何选取节点，and取节点属性有哪些方法？</h1>
<ul>
  <li>搜索节点名字
    <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">CComBSTR</span> <span class="nf">sstrRoot</span><span class="p">(</span><span class="s">L"root"</span><span class="p">);</span> <span class="c1">// sstrRoot("root");</span>
<span class="n">CComPtr</span><span class="o">&lt;</span><span class="n">IXMLDOMNode</span><span class="o">&gt;</span> <span class="n">rootNode</span><span class="p">;</span>
<span class="n">HRESULT</span> <span class="n">hr</span> <span class="o">=</span> <span class="n">iXMLDoc</span><span class="o">-&gt;</span><span class="n">selectSingleNode</span><span class="p">(</span><span class="n">sstrRoot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rootNode</span><span class="p">);</span>
<span class="n">CComPtr</span><span class="o">&lt;</span><span class="n">IXMLDOMNode</span><span class="o">&gt;</span> <span class="n">textNode</span><span class="p">;</span>
<span class="n">hr</span> <span class="o">=</span> <span class="n">rootNode</span><span class="o">-&gt;</span><span class="n">selectSingleNode</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">L"text"</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">textNode</span><span class="p">);</span> <span class="c1">// 搜索第一个"text"节点</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ul>

<h1 id="ixmldomnode与ixmldomelement接口有何联系区别">IXMLDOMNode与IXMLDOMElement接口有何联系、区别</h1>
<p>IXMLDOMElement接口继承于IXMLDOMNode接口，但除了从IXMLDOMNode接口继承的方法之外，IXMLDOMElement接口还向外暴露以下方法:</p>

<table>
  <thead>
    <tr>
      <th>方法</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>get_tagName</td>
      <td>检索元素名称（在tag之间的文本）。</td>
    </tr>
    <tr>
      <td>getAttribute</td>
      <td>检索所指定名字的属性的值。</td>
    </tr>
    <tr>
      <td>getAttributeNode</td>
      <td>检索所指定名字的属性的节点</td>
    </tr>
    <tr>
      <td>getElementsByTagName</td>
      <td>检索与提供的名称匹配的所有子元素的列表。</td>
    </tr>
    <tr>
      <td>removeAttribute</td>
      <td>移动或替换给定名称的属性</td>
    </tr>
    <tr>
      <td>removeAttributeNode</td>
      <td>从这个元素中移除指定的属性</td>
    </tr>
    <tr>
      <td>setAttribute</td>
      <td>为给定名称的属性设置值</td>
    </tr>
    <tr>
      <td>setAttributeNode</td>
      <td>在此元素上添加或替换提供的属性节点。</td>
    </tr>
  </tbody>
</table>

<p><br /></p>

<h1 id="节点如果是数组怎么操作">节点如果是数组，怎么操作？</h1>
<p>先使用get_childNodes函数获得子节点列表，然后遍历之用get_item依次取出每一项进行处理。</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>	<span class="n">CComPtr</span><span class="o">&lt;</span><span class="n">IXMLDOMElement</span><span class="o">&gt;</span> <span class="n">pRootElement</span><span class="p">;</span>
	<span class="n">CComPtr</span><span class="o">&lt;</span><span class="n">IXMLDOMNodeList</span><span class="o">&gt;</span> <span class="n">pNodeList</span><span class="p">;</span>
	<span class="n">pRootElement</span><span class="o">-&gt;</span><span class="n">get_childNodes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pNodeList</span><span class="p">);</span> <span class="c1">// Child node list</span>
	<span class="kt">long</span> <span class="n">nLen</span><span class="p">;</span>
	<span class="n">pNodeList</span><span class="o">-&gt;</span><span class="n">get_length</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nLen</span><span class="p">);</span>    <span class="c1">// Child node list</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">long</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">nLen</span><span class="p">;</span> <span class="o">++</span><span class="n">index</span><span class="p">)</span> <span class="c1">// Traverse</span>
	<span class="p">{</span>
		<span class="n">CComPtr</span><span class="o">&lt;</span><span class="n">IXMLDOMNode</span><span class="o">&gt;</span> <span class="n">pCurNode</span><span class="p">;</span>
		<span class="n">hr</span> <span class="o">=</span> <span class="n">pNodeList</span><span class="o">-&gt;</span><span class="n">get_item</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pCurNode</span><span class="p">);</span>
		<span class="k">do</span><span class="p">();</span>  <span class="c1">// 此处可做任何你想做的事情</span>
	<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p><br /></p>

<h1 id="如何为属性插入属性">如何为属性插入属性</h1>
<p>使用Element-&gt;setAttribute()即可，具体如下:</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">CComPtr</span><span class="o">&lt;</span><span class="n">IXMLDOMElement</span><span class="o">&gt;</span> <span class="n">imageElement</span><span class="p">;</span>
<span class="n">xmlDocData</span><span class="o">-&gt;</span><span class="n">createElement</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">L"Image"</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">imageElement</span><span class="p">);</span> <span class="c1">// 创建节点"Image"</span>
<span class="n">imageElement</span><span class="o">-&gt;</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">L"Type"</span><span class="p">),</span> <span class="n">CComVariant</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="n">imageType</span><span class="p">.</span><span class="n">c_str</span><span class="p">())));</span>  <span class="c1">// 添加属性"Type"</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p><br /></p>

<h1 id="字符串的转换与输出">字符串的转换与输出</h1>
<ul>
  <li>直接使用<code class="language-plaintext highlighter-rouge">printf</code>函数+“%ls”或<code class="language-plaintext highlighter-rouge">wprintf</code>函数+“%s”打印<code class="language-plaintext highlighter-rouge">BSTR</code>类字符串
    <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>  <span class="n">CComBSTR</span> <span class="n">ssName</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Node name:%ls</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ssName</span><span class="p">);</span>   <span class="c1">// 用%ls打印BSTR字符串内容</span>
  <span class="n">SysFreeString</span><span class="p">(</span><span class="n">ssName</span><span class="p">);</span>               <span class="c1">// 用完字符串后必须释放      </span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p>或</p>
    <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>  <span class="n">CComBSTR</span> <span class="n">ssName</span><span class="p">;</span>
  <span class="n">wprintf</span><span class="p">(</span><span class="s">L"Node name:%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ssName</span><span class="p">);</span>   <span class="c1">// 这里的L不能省略</span>
  <span class="n">SysFreeString</span><span class="p">(</span><span class="n">ssName</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>将<code class="language-plaintext highlighter-rouge">CComBSTR</code>类字符串的内容复制到<code class="language-plaintext highlighter-rouge">wstring</code>中，然后使用<code class="language-plaintext highlighter-rouge">wcout</code>输出
    <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre> <span class="n">CComBSTR</span> <span class="n">ssName</span><span class="p">;</span>
 <span class="n">wstring</span> <span class="nf">bstrText</span><span class="p">(</span><span class="n">ssName</span><span class="p">);</span>
 <span class="n">wcout</span> <span class="o">&lt;&lt;</span> <span class="n">bstrText</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ul>

<p>或</p>
<ul>
  <li>先使用将bstr转为<code class="language-plaintext highlighter-rouge">std::wstring</code>，然后<code class="language-plaintext highlighter-rouge">wcout</code>
    <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">std</span><span class="o">::</span><span class="n">wstring</span> <span class="nf">wstringName</span><span class="p">(</span><span class="n">ssName</span><span class="p">,</span> <span class="n">SysStringLen</span><span class="p">(</span><span class="n">ssName</span><span class="p">));</span>
<span class="n">wcout</span> <span class="o">&lt;&lt;</span> <span class="n">wstringName</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>先将<code class="language-plaintext highlighter-rouge">CComBSTR</code>类字符串强转为<code class="language-plaintext highlighter-rouge">LPCTSTR</code>类型后，然后使用<code class="language-plaintext highlighter-rouge">wcout</code>输出
对<code class="language-plaintext highlighter-rouge">CStringW</code>类字符串而言，这已经是一种比较简单的方式了。
    <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>  <span class="n">CComBSTR</span> <span class="n">ssName</span><span class="p">;</span>
  <span class="n">CString</span> <span class="nf">cstring</span><span class="p">(</span><span class="n">ssName</span><span class="p">);</span>
  <span class="n">wcout</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">LPCTSTR</span><span class="p">)</span><span class="n">cstring</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>将<code class="language-plaintext highlighter-rouge">CComBSTR</code>类字符串的内容复制到<code class="language-plaintext highlighter-rouge">CW2A</code>类字符串(多字节字符串)中，然后使用<code class="language-plaintext highlighter-rouge">wcout</code>输出
    <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">CComBSTR</span> <span class="n">ssName</span><span class="p">;</span>
<span class="n">CW2A</span> <span class="nf">printstr</span><span class="p">(</span><span class="n">ssName</span><span class="p">);</span>
<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">printstr</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>先使用宏W2A将bstr转为std::string，然后cout
    <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">USES_CONVERSION</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">stringName</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">W2A</span><span class="p">(</span><span class="n">ssName</span><span class="p">));</span>
<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">stringName</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ul>

<p><br /></p>

<h2 id="主要代码">主要代码</h2>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
</pre></td><td class="rouge-code"><pre><span class="cp">#include &lt;msxml6.h&gt;   // 含有 MSXML最新版
#include &lt;atlbase.h&gt;
#include "atlstr.h"  // 含有CString, CStringW和CW2A
#include &lt;iostream&gt;  // 包含wcout函数
#include &lt;string&gt;    // 包含 c_str()函数, wcout
#include "comutil.h" // 包含_bstr_t
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="k">const</span> <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="s">L""</span>
<span class="s">L"&lt;?xml version=</span><span class="se">\"</span><span class="s">1.0</span><span class="se">\"</span><span class="s"> encoding=</span><span class="se">\"</span><span class="s">utf-16</span><span class="se">\"</span><span class="s">?&gt;</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">L"&lt;root desc=</span><span class="se">\"</span><span class="s">Great</span><span class="se">\"</span><span class="s">&gt;</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">L"  &lt;text&gt;Hey&lt;/text&gt;</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">L"    &lt;layouts&gt;</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">L"    &lt;lay index=</span><span class="se">\"</span><span class="s">15</span><span class="se">\"</span><span class="s"> bold=</span><span class="se">\"</span><span class="s">true</span><span class="se">\"</span><span class="s">/&gt;</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">L"    &lt;layoff index=</span><span class="se">\"</span><span class="s">12</span><span class="se">\"</span><span class="s">/&gt;</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">L"    &lt;layin index=</span><span class="se">\"</span><span class="s">17</span><span class="se">\"</span><span class="s">/&gt;</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">L"  &lt;/layouts&gt;</span><span class="se">\r\n</span><span class="s">"</span>
<span class="s">L"&lt;/root&gt;</span><span class="se">\r\n</span><span class="s">"</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">CoInitialize</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span> <span class="c1">// Initialize COM</span>

	<span class="n">CComPtr</span><span class="o">&lt;</span><span class="n">IXMLDOMDocument</span><span class="o">&gt;</span> <span class="n">iXMLDoc</span><span class="p">;</span>  <span class="c1">// Or use CComPtr&lt;IXMLDOMDocument2&gt;, CComPtr&lt;IXMLDOMDocument3&gt;</span>

	<span class="k">try</span>
	<span class="p">{</span>
		<span class="n">HRESULT</span> <span class="n">hr</span> <span class="o">=</span> <span class="n">iXMLDoc</span><span class="p">.</span><span class="n">CoCreateInstance</span><span class="p">(</span><span class="kr">__uuidof</span><span class="p">(</span><span class="n">DOMDocument</span><span class="p">));</span>
		<span class="c1">// 	iXMLDoc.CoCreateInstance(__uuidof(DOMDocument60));</span>

		<span class="c1">// Load the file. </span>
		<span class="n">VARIANT_BOOL</span> <span class="n">bSuccess</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="c1">// Load it from a url/filename...</span>
		<span class="n">hr</span> <span class="o">=</span> <span class="n">iXMLDoc</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">(</span><span class="n">CComVariant</span><span class="p">(</span><span class="s">L"./test.xml"</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bSuccess</span><span class="p">);</span>
		<span class="c1">// filePath = "./test.xml";</span>
		<span class="c1">// hr = iXMLDoc-&gt;load(CComVariant(filePath.c_str()), &amp;bSuccess);</span>

		<span class="c1">// or from a BSTR...</span>
		<span class="c1">// iXMLDoc-&gt;loadXML(CComBSTR(src), &amp;bSuccess);</span>

		<span class="c1">// Get a smart pointer (sp) to the root</span>
		<span class="n">CComPtr</span><span class="o">&lt;</span><span class="n">IXMLDOMElement</span><span class="o">&gt;</span> <span class="n">pRootElement</span><span class="p">;</span>
		<span class="n">hr</span> <span class="o">=</span> <span class="n">iXMLDoc</span><span class="o">-&gt;</span><span class="n">get_documentElement</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pRootElement</span><span class="p">);</span> <span class="c1">// Root elements</span>

		<span class="c1">// Get Attribute value of the note "root"</span>
		<span class="n">CComBSTR</span> <span class="n">ssDesc</span><span class="p">(</span><span class="s">"desc"</span><span class="p">);</span>
		<span class="n">CComVariant</span> <span class="n">deVal</span><span class="p">(</span><span class="n">VT_EMPTY</span><span class="p">);</span>
		<span class="n">hr</span> <span class="o">=</span> <span class="n">pRootElement</span><span class="o">-&gt;</span><span class="n">getAttribute</span><span class="p">(</span><span class="n">ssDesc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">deVal</span><span class="p">);</span>

		<span class="n">CComBSTR</span> <span class="n">sstrRoot</span><span class="p">(</span><span class="s">L"root"</span><span class="p">);</span> <span class="c1">// sstrRoot("root");</span>
		<span class="n">CComPtr</span><span class="o">&lt;</span><span class="n">IXMLDOMNode</span><span class="o">&gt;</span> <span class="n">rootNode</span><span class="p">;</span>
		<span class="n">hr</span> <span class="o">=</span> <span class="n">iXMLDoc</span><span class="o">-&gt;</span><span class="n">selectSingleNode</span><span class="p">(</span><span class="n">sstrRoot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rootNode</span><span class="p">);</span>  <span class="c1">// Search "root"</span>

		<span class="n">CComBSTR</span> <span class="n">rootText</span><span class="p">;</span>
		<span class="n">hr</span> <span class="o">=</span> <span class="n">rootNode</span><span class="o">-&gt;</span><span class="n">get_text</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rootText</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">wstring</span> <span class="n">bstrText</span><span class="p">(</span><span class="n">rootText</span><span class="p">);</span>
			<span class="n">wcout</span> <span class="o">&lt;&lt;</span> <span class="s">"Text of root: "</span> <span class="o">&lt;&lt;</span> <span class="n">bstrText</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">CComPtr</span><span class="o">&lt;</span><span class="n">IXMLDOMNode</span><span class="o">&gt;</span> <span class="n">descAttribute</span><span class="p">;</span>
		<span class="n">hr</span> <span class="o">=</span> <span class="n">rootNode</span><span class="o">-&gt;</span><span class="n">selectSingleNode</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">"@desc"</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">descAttribute</span><span class="p">);</span> <span class="c1">// Atrribute需要用@, 而各个节点不能使用@作为前缀来搜索</span>
		<span class="n">CComBSTR</span> <span class="n">descVal</span><span class="p">;</span>
		<span class="n">hr</span> <span class="o">=</span> <span class="n">descAttribute</span><span class="o">-&gt;</span><span class="n">get_text</span><span class="p">(</span><span class="o">&amp;</span><span class="n">descVal</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">wstring</span> <span class="n">bstrText</span><span class="p">(</span><span class="n">descVal</span><span class="p">);</span>
			<span class="n">wcout</span> <span class="o">&lt;&lt;</span> <span class="s">"Desc Attribute: "</span> <span class="o">&lt;&lt;</span> <span class="n">bstrText</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">FAILED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">wstring</span> <span class="n">strVal</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">deVal</span><span class="p">.</span><span class="n">vt</span> <span class="o">==</span> <span class="n">VT_BSTR</span><span class="p">)</span>
				<span class="n">strVal</span> <span class="o">=</span> <span class="n">deVal</span><span class="p">.</span><span class="n">bstrVal</span><span class="p">;</span>

			<span class="n">wcout</span> <span class="o">&lt;&lt;</span> <span class="s">"desc: "</span> <span class="o">&lt;&lt;</span> <span class="n">strVal</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">CComPtr</span><span class="o">&lt;</span><span class="n">IXMLDOMNodeList</span><span class="o">&gt;</span> <span class="n">pNodeList</span><span class="p">;</span>
		<span class="n">pRootElement</span><span class="o">-&gt;</span><span class="n">get_childNodes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pNodeList</span><span class="p">);</span> <span class="c1">// Child node list</span>
		<span class="kt">long</span> <span class="n">nLen</span><span class="p">;</span>
		<span class="n">pNodeList</span><span class="o">-&gt;</span><span class="n">get_length</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nLen</span><span class="p">);</span>    <span class="c1">// Child node list</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">nLen</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="c1">// Traverse</span>
		<span class="p">{</span>
			<span class="n">CComPtr</span><span class="o">&lt;</span><span class="n">IXMLDOMNode</span><span class="o">&gt;</span> <span class="n">pNode</span><span class="p">;</span>
			<span class="n">hr</span> <span class="o">=</span> <span class="n">pNodeList</span><span class="o">-&gt;</span><span class="n">get_item</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pNode</span><span class="p">);</span>

			<span class="n">CComBSTR</span> <span class="n">ssName</span><span class="p">;</span>
			<span class="n">CComVariant</span> <span class="n">val</span><span class="p">(</span><span class="n">VT_EMPTY</span><span class="p">);</span>
			<span class="n">hr</span> <span class="o">=</span> <span class="n">pNode</span><span class="o">-&gt;</span><span class="n">get_nodeName</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssName</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">wstring</span> <span class="n">bstrText</span><span class="p">(</span><span class="n">ssName</span><span class="p">);</span>
				<span class="n">wcout</span> <span class="o">&lt;&lt;</span> <span class="s">"Name of node "</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">": "</span> <span class="o">&lt;&lt;</span> <span class="n">bstrText</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

				<span class="n">CString</span> <span class="n">cstring</span><span class="p">(</span><span class="n">ssName</span><span class="p">);</span>
				<span class="c1">// To display a CStringW correctly, use wcout and cast cstring to (LPCTSTR), an easier way to display wide character strings.</span>
				<span class="n">wcout</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">LPCTSTR</span><span class="p">)</span><span class="n">cstring</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

				<span class="c1">// CW2A converts the string in ccombstr to a multi-byte string in printstr, used for display output.</span>
				<span class="n">CW2A</span> <span class="n">printstr</span><span class="p">(</span><span class="n">ssName</span><span class="p">);</span>
				<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">printstr</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="c1">// Add(Append) node</span>
		<span class="n">CComPtr</span><span class="o">&lt;</span><span class="n">IXMLDOMDocument</span><span class="o">&gt;&amp;</span> <span class="n">xmlDocData</span><span class="p">(</span><span class="n">iXMLDoc</span><span class="p">);</span>
		<span class="n">CComPtr</span><span class="o">&lt;</span><span class="n">IXMLDOMElement</span><span class="o">&gt;</span> <span class="n">imageElement</span><span class="p">;</span>
		<span class="n">CComPtr</span><span class="o">&lt;</span><span class="n">IXMLDOMNode</span><span class="o">&gt;</span> <span class="n">newImageNode</span><span class="p">;</span>
		<span class="n">string</span> <span class="n">imageType</span> <span class="o">=</span> <span class="s">"jpeg"</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">];</span>
		<span class="n">GetCurrentDirectory</span><span class="p">(</span><span class="n">MAX_PATH</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>  <span class="c1">//  Get Current Directory</span>
		<span class="n">string</span> <span class="n">path</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span> <span class="c1">// Copy content of char*, generate a string</span>
		<span class="n">string</span> <span class="n">imagePath</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s">"</span><span class="se">\\</span><span class="s">com.jpg"</span><span class="p">;</span>

		<span class="n">xmlDocData</span><span class="o">-&gt;</span><span class="n">createElement</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">L"Image"</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">imageElement</span><span class="p">);</span>
		<span class="n">imageElement</span><span class="o">-&gt;</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">L"Type"</span><span class="p">),</span> <span class="n">CComVariant</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="n">imageType</span><span class="p">.</span><span class="n">c_str</span><span class="p">())));</span> <span class="c1">// 为当前节点添加属性</span>
		<span class="n">imageElement</span><span class="o">-&gt;</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">L"FileName"</span><span class="p">),</span> <span class="n">CComVariant</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="n">imagePath</span><span class="p">.</span><span class="n">c_str</span><span class="p">())));</span>
		<span class="n">rootNode</span><span class="o">-&gt;</span><span class="n">appendChild</span><span class="p">(</span><span class="n">imageElement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newImageNode</span><span class="p">);</span>

		<span class="c1">// Remove "text" node under "root" node</span>
		<span class="n">CComPtr</span><span class="o">&lt;</span><span class="n">IXMLDOMNode</span><span class="o">&gt;</span> <span class="n">xmlOldNode</span><span class="p">;</span>
		<span class="n">CComPtr</span><span class="o">&lt;</span><span class="n">IXMLDOMNode</span><span class="o">&gt;</span> <span class="n">textNode</span><span class="p">;</span>
		<span class="n">hr</span> <span class="o">=</span> <span class="n">rootNode</span><span class="o">-&gt;</span><span class="n">selectSingleNode</span><span class="p">(</span><span class="n">CComBSTR</span><span class="p">(</span><span class="s">L"text"</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">textNode</span><span class="p">);</span> <span class="c1">// Search "text" node		</span>
		<span class="n">hr</span> <span class="o">=</span> <span class="n">rootNode</span><span class="o">-&gt;</span><span class="n">removeChild</span><span class="p">(</span><span class="n">textNode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xmlOldNode</span><span class="p">);</span>

		<span class="c1">// Update XML</span>
		<span class="n">hr</span> <span class="o">=</span> <span class="n">iXMLDoc</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">(</span><span class="n">CComVariant</span><span class="p">(</span><span class="s">"updated.xml"</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">catch</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">pStrErr</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// Some error...</span>
		<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">pStrErr</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
	<span class="p">}</span> <span class="c1">// catch</span>
	<span class="k">catch</span> <span class="p">(...)</span> <span class="p">{</span>
		<span class="c1">// Unknown error...</span>
		<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Unknown error..."</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="c1">// Release() - that gets done automatically, also can manually do for each opened node or elements.</span>
	<span class="c1">// iXMLDoc.Release();</span>

	<span class="c1">// Stop COM</span>
	<span class="n">CoUninitialize</span><span class="p">();</span>

	<span class="n">system</span><span class="p">(</span><span class="s">"pause"</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>运行结果:
<img src="https://cdn.jsdelivr.net/gh/yanglr/yanglr.github.io/assets/images/public/2019-01-10-run-result.png" alt="run Result" /></p>

<p>运行完，得到的update.xml内容为:</p>

<p><a rel="nofollow noopener noreferrer" target="_blank" href="https://cdn.jsdelivr.net/gh/yanglr/SimpleParser4MSXML-cpp/msxmlDemo/updated.xml">https://cdn.jsdelivr.net/gh/yanglr/SimpleParser4MSXML-cpp/msxmlDemo/updated.xml</a></p>

<p><br /></p>

<p><strong>参考资料:</strong></p>
<ol>
  <li><a rel="nofollow noopener noreferrer" target="_blank" href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/dd874725%28v=vs.85%29">IXMLDOMElement接口</a></li>
  <li><a rel="nofollow noopener noreferrer" target="_blank" href="http://www.endurasoft.com/vcd/msxml1.htm">Using the MSXML Parser</a></li>
  <li><a rel="nofollow noopener noreferrer" target="_blank" href="https://social.msdn.microsoft.com/Forums/vstudio/en-US/d3fbeea4-fdf9-48f9-9513-42cde8a833d6/mfc-c-xml-parse-using-msxml">MFC C++ XML Parse - Using MSXML</a></li>
  <li><a rel="nofollow noopener noreferrer" target="_blank" href="https://docs.microsoft.com/zh-cn/cpp/text/how-to-convert-between-various-string-types?view=vs-2017">如何：各种字符串类型之间转换 - Microsoft Docs</a></li>
</ol>

<hr />

<p><strong>作者简介</strong>：Bravo Yeung，计算机硕士，知乎干货答主(获<strong>81K</strong> 赞同, <strong>38K</strong> 感谢, <strong>235K</strong> 收藏)。曾在国内 Top3互联网视频直播公司工作过，后加入一家外企做软件开发至今。</p>

<p><br /></p>

<p>如需转载，请加微信 <strong>iMath7</strong> 申请开白！</p>

<p><br /></p>

<p>欢迎在留言区留下你的观点，一起讨论提高。如果今天的文章让你有新的启发，学习能力的提升上有新的认识，欢迎转发分享给更多人。</p>

<p><br /></p>

<p>欢迎各位读者加入 <strong>.NET技术交流群</strong>，在公众号后台回复<strong>“加群”</strong>或者<strong>“学习”</strong>即可。</p>

<p><br /></p>

<p><img src="https://gitee.com/geekplayers/images/raw/master/gzhCard_blog.png" alt="大白技术控 公众号名片" /></p>

<h3 id="文末彩蛋">文末彩蛋</h3>

<blockquote>
  <p>微信后台回复“<strong>asp</strong>”，给你：一份全网最强的ASP.NET学习路线图。
<br />
回复“<strong>cs</strong>”，给你：一整套 C# 和 WPF 学习资源！
<br />
回复“<strong>core</strong>”，给你：2019年dotConf大会上发布的.NET core 3.0学习视频！</p>
</blockquote>


            <style>
.PageNav {
  font-size: 14px;
  display: block;
  width: auto;
  overflow: hidden;
}

.PageNav a {
  display: block;
  width: 50%;
  float: left;
  margin: 1em 0;
}

.PageNav .next {
  text-align: right;
}    
</style>

<div style="margin-top:2em; padding:0 1.5em; border:1px solid #d3d3d3; background-color:#deebf7">
    <h3>版权声明</h3>
    <ul>
        <li>本文作者：<a href="" target="_blank">极客玩家大白</a></li>
        <li>本文链接：<a href="/xml-parse-guide-based-on-MSXML-using-cpp.html" target="_blank">http://localhost:4000/xml-parse-guide-based-on-MSXML-using-cpp.html</a></li>
        <li>郑重声明：本文为博主原创或经授权转载的文章，欢迎转载，但<b>转载文章之后必须在文章页面明显位置注明出处</b>，否则保留追究法律责任的权利。如您有任何疑问或者授权方面的协商，请留言。</li>
    </ul>
</div>

<div class="PageNav">
    
    <a class="prev" href="/calculator_using_caliburn-micro_from0to1.html"><i class="fa fa-arrow-left"></i>&nbsp;从0到1：使用Caliburn.Micro(WPF和MVVM)开发简单的计算器</a>
    
    
    <a class="next" href="/cnblogs-markdown-code-opt.html"> 改进博客园Markdown显示功能(加代码行号、显示代码所用编程语言)&nbsp;<i class="fa fa-arrow-right"></i></a>
    
</div>

<div>
    <p align="center">
        
        <img src="//cdn.jsdelivr.net/gh/yanglr/yanglr.github.io/assets/images/dotnet.jpg" width="300" height="300">
        
        <br />
        一个有故事的程序员
    </p>
    <p align="center" style="margin-top: 15px; font-size: 11px;color: #cc0000;">
        <strong>（转载本站文章请注明作者和出处 <a href="//geekplayers.com">极客玩家大白</a>）</strong>
    </p>
    <p align="center" style="margin-top: 15px; font-size: 16px;color: #337ab7;">
        <strong><a href="//geekplayers.com" target="_blank">点击了解 ：.NET技术人的网站</a></strong>
    </p>
</div>

            <!-- Comments -->
            <div class="comment">
             

  
    <a href="#" class="show_disqus_comment" onclick="return false;">Show Disqus Comments</a>
    <div id="disqus_thread"></div>
    <script>
    var disqus_config = function () {
        this.page.url = 'http://localhost:4000/xml-parse-guide-based-on-MSXML-using-cpp.html';
        this.page.identifier = '/xml-parse-guide-based-on-MSXML-using-cpp.html';
        this.page.title = '史上最最靠谱，又双叒叒(ruò,zhuó)简单的基于MSXML的XML解析指南-C++';
    };
    var disqus_loaded = false;
    $(function() {
        $('.show_disqus_comment').on('click', function() { // DON'T EDIT BELOW THIS LINE
            $(this).html('加载中...');
            var that = this;
            if (!disqus_loaded) {
                var d = document, s = d.createElement('script');

                s.type = 'text/javascript';
                s.async = true;
                var shortname = 'yanglr';

                s.src = '//' + shortname + '.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);

                disqus_loaded = true;
            }
            $(that).remove();
        })
    })
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  

  
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/yanglr/yanglr.github.io/assets/css/gitalk.css"> <!-- 根据 cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css 微调 -->
        <script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
        <script>
        var title = location.pathname.substr(0, 50); //截取路径的前50个字符作为标识符          
        var gitalk = new Gitalk({
            id: title,
            clientID: '22eb6462c987e7a79860',
            clientSecret: '6cd15fa90d4e2f73fa16eaab9b3f783831fe3f3d',
            repo: 'geekplayers.com',
            owner: 'yanglr',
            admin: ['yanglr'],
            labels: ['gitalk'],
            perPage: 50
        })
        gitalk.render('gitalk-container');
        </script>
  


            </div>
        </div>

        <div class="col-md-3">
            <h3>Post Directory</h3>
<div id="post-directory-module">
<section class="post-directory">
    <!-- Links that trigger the jumping -->
    <!-- Added by javascript below -->
    <dl></dl>
</section>
</div>

<script type="text/javascript">

    $(document).ready(function(){
        $( "article h2" ).each(function( index ) {
            $(".post-directory dl").append("<dt><a class=\"jumper\" hre=#" +
                    $(this).attr("id")
                    + ">"
                    + $(this).text()
                    + "</a></dt>");

            var children = $(this).nextUntil("h2", "h3")

            children.each(function( index ) {
                $(".post-directory dl").append("<dd><a class=\"jumper\" hre=#" +
                        $(this).attr("id")
                        + ">"
                        + "&nbsp;&nbsp;- " + $(this).text()
                        + "</a></dd>");
            });
        });

        var fixmeTop = $('#post-directory-module').offset().top - 100;       // get initial position of the element

        $(window).scroll(function() {                  // assign scroll event listener

            var currentScroll = $(window).scrollTop(); // get current position

            if (currentScroll >= fixmeTop) {           // apply position: fixed if you
                $('#post-directory-module').css({      // scroll to that element or below it
                    top: '100px',
                    position: 'fixed',
                    width: 'inherit'
                });
            } else {                                   // apply position: static
                $('#post-directory-module').css({      // if you scroll above it
                    position: 'inherit',
                    width: 'inherit'
                });
            }

        });

        $("a.jumper").on("click", function( e ) {

            e.preventDefault();

            $("body, html").animate({
                scrollTop: ($( $(this).attr('hre') ).offset().top - 100)
            }, 600);

        });
    });

</script>
        </div>
        

    </div>

</article>

<script type="text/javascript">
    const headings = document.querySelectorAll('h2,h3,h4'); // 1
    const linkContent = '<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'; // 2
    for (const heading of headings) { // 3
        const linkIcon = document.createElement('a'); // 4
        
        if(heading.id != '')
        {
            linkIcon.setAttribute('href', `#${heading.id}`); // 5
            linkIcon.innerHTML = linkContent; // 6
            heading.firstChild.textContent = ' ' + heading.firstChild.textContent;
            heading.insertBefore(linkIcon, heading.firstChild);; // 7
        }
    }
</script>
        </div>

    
    <footer class="container">
        <div class="site-footer">
            <!--  <div class="site-footer-icons">
            <a target="_blank" href="https://www.zhihu.com/people/legege007">
               知乎
            </a>
            <a target="_blank" href="http://weibo.com/540071991">
               微博
            </a>
            <a target="_blank" href="https://github.com/yanglr">
                GitHub
            </a>
        </div> -->
            <div class="card text-center">
                <ul class="list-inline" style="margin-left: 0;">
                    <li>
                        <a target="_blank" href="https://github.com/yanglr">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/legege007">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                    <li>
                        <a target="_blank" href="https://weibo.com/540071991">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="site-footer-links mobile-hidden">
                
                <a href="/docker.html" title="Docker" target="_blank">Docker</a>
                
                <a href="/open-source.html" title="Code" target="_blank">Code</a>
                
                <a href="/geektime.html" title="极客" target="_blank">极客</a>
                
            </div>
            <!--         <div class="site-footer-icons">
                   沪ICP备20019934号-2
            </div> -->
            <div class="scrolltop">
                粤ICP备12009483号（Gitee站）
                <a href="javascript:window.scrollTo(0,0)">TOP↑</a>
            </div>
            <div class="rss">
                <a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a>
                Power by <a href="https://github.com/DONGChuan/Yummy-Jekyll">Yummy Jekyll</a>
            </div>
        </div>
        <!-- Third-Party JS -->
        <script type="text/javascript" src="//cdn.jsdelivr.net/gh/yanglr/yanglr.github.io/bower_components/geopattern/js/geopattern.min.js"></script>
        <!-- My JS -->
        <script type="text/javascript" src="//cdn.jsdelivr.net/gh/yanglr/yanglr.github.io/assets/js/script.js"></script>
        

        <!-- Cnzz Analytics -->
        <script type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1279049771'%3E%3C/span%3E%3Cscript src='https://v1.cnzz.com/z_stat.php%3Fid%3D1279049771%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));
        </script>
        <!-- Cnzz Analytics -->
    </footer>


    </body>

</html>
